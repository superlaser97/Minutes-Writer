<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minutes Writer</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <style>
        /* Define your color palette as CSS variables */
        :root {
            --color-background: #F9FAFB;
            --color-background-main: #FFFFFF;
            --color-text-primary: #1F2937;
            --color-text-secondary: #6B7280;
            --color-primary: #4F46E5;
            --color-primary-hover: #4338CA;
            --color-secondary-bg: #FFFFFF;
            --color-border: #E5E7EB;
            --color-input-bg: #FFFFFF;
            --color-icon-hover-bg: #F3F4F6;
            --color-resizer-bg: #E5E7EB;
            --color-kbd-text: #1F2937;
            --color-kbd-bg: #F3F4F6;
            --color-kbd-border: #E5E7EB;
            --color-placeholder: #9CA3AF;
        }

        .dark {
            --color-background: #111827;
            --color-background-main: #1F2937;
            --color-text-primary: #F9FAFB;
            --color-text-secondary: #9CA3AF;
            --color-primary: #6366F1;
            --color-primary-hover: #4F46E5;
            --color-secondary-bg: #1F2937;
            --color-border: #374151;
            --color-input-bg: #374151;
            --color-icon-hover-bg: #374151;
            --color-resizer-bg: #374151;
            --color-kbd-text: #F9FAFB;
            --color-kbd-bg: #4B5563;
            --color-kbd-border: #6B7280;
            --color-placeholder: #6B7280;
        }
        
        /* Custom scrollbar styling */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { @apply bg-gray-100 dark:bg-gray-800 rounded-lg; }
        ::-webkit-scrollbar-thumb { @apply bg-gray-400 dark:bg-gray-600 rounded-lg; }
        ::-webkit-scrollbar-thumb:hover { @apply bg-gray-500 dark:bg-gray-500; }

        /* This style forces the action buttons to be visible when edit mode is active */
        #shortcuts-list.edit-mode-active .shortcut-actions {
            opacity: 1;
        }

        /* Style for the tab rename input */
        .tab-rename-input {
            background-color: var(--color-input-bg);
            border: 1px solid var(--color-primary);
            color: var(--color-text-primary);
            border-radius: 4px;
            padding: 1px 4px;
            width: 100%;
            outline: none;
        }
    </style>
</head>
<body class="bg-[var(--color-background)] text-[var(--color-text-primary)] font-sans transition-colors duration-300 ease-in-out select-none">

    <div id="main-container" class="flex flex-col md:flex-row h-screen antialiased">

        <aside id="left-panel" class="w-full md:w-1/3 lg:w-1/4 p-6 bg-[var(--color-secondary-bg)] border-r border-[var(--color-border)] flex flex-col flex-shrink-0">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-2xl font-bold text-[var(--color-primary)]">Minutes Writer</h1>
                <button id="theme-toggle" class="p-2 rounded-full hover:bg-[var(--color-icon-hover-bg)] focus:outline-none cursor-pointer">
                    <span id="theme-icon-sun" class="block dark:hidden">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="w-6 h-6 text-yellow-500" fill="currentColor"><path d="M256 160c-52.9 0-96 43.1-96 96s43.1 96 96 96 96-43.1 96-96-43.1-96-96-96zm246.4 80.5l-94.7-47.3 33.5-100.4c4.5-13.6-8.4-26.5-21.9-21.9l-100.4 33.5-47.3-94.7c-9.8-19.6-39.1-19.6-48.9 0L176 111.8 75.6 78.3c-13.6-4.5-26.5 8.4-21.9 21.9l33.5 100.4-94.7 47.3c-19.6 9.8-19.6 39.1 0 48.9l94.7 47.3-33.5 100.4c-4.5 13.6 8.4 26.5 21.9 21.9l100.4-33.5 47.3 94.7c9.8 19.6 39.1 19.6 48.9 0l47.3-94.7 100.4 33.5c13.6 4.5 26.5-8.4 21.9-21.9l-33.5-100.4 94.7-47.3c19.5-9.8 19.5-39.1 0-48.9z"/></svg>
                    </span>
                    <span id="theme-icon-moon" class="hidden dark:block">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512" class="w-6 h-6 text-blue-300" fill="currentColor"><path d="M223.5 32C100 32 0 132.3 0 256S100 480 223.5 480c60.6 0 115.5-24.2 155.8-63.4c5-4.9 6.3-12.5 3.1-18.7s-10.1-9.7-17-8.5c-9.8 1.7-20 2.6-30.6 2.6c-96.8 0-175.5-78.8-175.5-176c0-63.6 34.4-120.7 86.8-153.1c5.2-3.2 8.7-8.9 7.2-14.9s-7.4-10.4-13.4-10.4c-5.8 0-11.5 .6-17.1 1.7z"/></svg>
                    </span>
                </button>
            </div>

            <div class="mb-3">
                <div class="flex justify-between items-center">
                    <h2 id="form-title" class="text-lg font-semibold">Add Shortcut</h2>
                    <button id="toggle-form-btn" title="Toggle Form" class="text-[var(--color-text-secondary)] hover:text-[var(--color-primary)] p-2 rounded-full text-sm cursor-pointer">
                        <span id="toggle-form-icon-container">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="w-5 h-5" fill="currentColor"><path d="M233.4 105.4c12.5-12.5 32.8-12.5 45.3 0l192 192c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L256 173.3 86.6 342.6c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3l192-192z"/></svg>
                        </span>
                    </button>
                </div>
                <div id="add-shortcut-container" class="transition-all duration-300 ease-in-out overflow-hidden">
                    <form id="shortcut-form">
                        <div class="mb-4">
                            <label for="shortcut-key" class="block text-sm font-medium text-[var(--color-text-secondary)] mb-1">Trigger Keys</label>
                            <input type="text" id="shortcut-key" placeholder="e.g., Ctrl + M" class="w-full px-3 py-2 bg-[var(--color-input-bg)] border border-[var(--color-border)] rounded-md placeholder:text-[var(--color-placeholder)]" readonly>
                            <p class="text-xs text-[var(--color-text-secondary)] mt-1">Click here and press your desired key combination.</p>
                        </div>
                        <div class="mb-4">
                            <label for="shortcut-text" class="block text-sm font-medium text-[var(--color-text-secondary)] mb-1">Text to Insert</label>
                            <textarea id="shortcut-text" rows="3" placeholder="Type the text to be inserted..." class="w-full px-3 py-2 bg-[var(--color-input-bg)] border border-[var(--color-border)] rounded-md resize-none focus:border-[var(--color-primary)] placeholder:text-[var(--color-placeholder)]"></textarea>
                        </div>
                        <div class="flex space-x-2">
                            <button type="submit" id="form-submit-btn" class="flex-grow bg-[var(--color-primary)] hover:bg-[var(--color-primary-hover)] text-white font-bold py-2 px-4 rounded-md shadow-sm hover:shadow-lg transition-all duration-200 cursor-pointer flex items-center justify-center">
                                <span class="form-submit-icon-container mr-2 w-4 h-4 inline-block">
                                    <svg id="icon-plus" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="w-full h-full" fill="currentColor"><path d="M256 80c0-17.7-14.3-32-32-32s-32 14.3-32 32V224H48c-17.7 0-32 14.3-32 32s14.3 32 32 32H192V432c0 17.7 14.3 32 32 32s32-14.3 32-32V288H400c17.7 0 32-14.3 32-32s-14.3-32-32-32H256V80z"/></svg>
                                    <svg id="icon-save" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="w-full h-full hidden" fill="currentColor"><path d="M48 96V416c0 8.8 7.2 16 16 16H384c8.8 0 16-7.2 16-16V170.5c0-4.2-1.7-8.3-4.7-11.3l-80-80c-3-3-7.1-4.7-11.3-4.7H64c-8.8 0-16 7.2-16 16zm80 0v64H288V96H128zm-17.2 246.3c6.2-6.2 16.4-6.2 22.6 0L160 368.4l22.6-22.6c6.2-6.2 16.4-6.2 22.6 0s6.2 16.4 0 22.6l-33.9 33.9c-6.2 6.2-16.4 6.2-22.6 0L102.8 365c-6.2-6.2-6.2-16.4 0-22.6zM256 224a64 64 0 1 1 0 128 64 64 0 1 1 0-128z"/></svg>
                                </span>
                                <span id="submit-btn-text">Add Shortcut</span>
                            </button>
                            <button type="button" id="cancel-edit-btn" class="hidden bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-md shadow-sm hover:shadow-lg transition-all duration-200 cursor-pointer">
                                Cancel
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <div class="flex-grow overflow-y-auto">
                <div class="flex justify-between items-center">
                    <h2 class="text-lg font-semibold">Your Shortcuts</h2>
                    <div class="flex items-center space-x-2">
                        <button id="manage-shortcuts-btn" title="Manage Shortcuts" class="text-[var(--color-text-secondary)] hover:text-[var(--color-primary)] p-2 rounded-full text-sm cursor-pointer">
                            <span id="manage-shortcuts-icon-container" class="w-5 h-5 inline-block">
                                <svg id="icon-pencil" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="w-full h-full" fill="currentColor"><path d="M410.3 231l11.3-11.3-33.9-33.9-62.1-62.1L291.7 89.8l-11.3 11.3-22.6 22.6L58.6 322.9c-10.4 10.4-18 23.3-22.2 37.4L1 480.7c-2.5 8.4-.2 17.5 6.1 23.7s15.3 8.5 23.7 6.1l120.3-35.4c14.1-4.2 27-11.8 37.4-22.2L387.7 253.7 410.3 231zM160 399.4l-9.1 22.7c-4 3.1-8.5 5.4-13.3 6.9L5.9 452.5l22.7-9.1c3.1-4 5.4-8.5 6.9-13.3l22.7-9.1z"/></svg>
                                <svg id="icon-check" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="w-full h-full hidden" fill="currentColor"><path d="M438.6 105.4c12.5 12.5 12.5 32.8 0 45.3l-256 256c-12.5 12.5-32.8 12.5-45.3 0l-128-128c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0L160 338.7 393.4 105.4c12.5-12.5 32.8-12.5 45.3 0z"/></svg>
                            </span>
                        </button>
                        <button id="import-btn" title="Import Shortcuts" class="text-[var(--color-text-secondary)] hover:text-[var(--color-primary)] p-2 rounded-full text-sm cursor-pointer">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="w-5 h-5" fill="currentColor"><path d="M288 109.3V352c0 17.7-14.3 32-32 32s-32-14.3-32-32V109.3l-73.4 73.4c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3l128-128c12.5-12.5 32.8-12.5 45.3 0l128 128c12.5 12.5 12.5 32.8 0 45.3s-32.8-12.5-45.3 0L288 109.3zM64 352H192c0 35.3 28.7 64 64 64s64-28.7 64-64H448c35.3 0 64 28.7 64 64v32c0 35.3-28.7 64-64 64H64c-35.3 0-64-28.7-64-64v-32c0-35.3 28.7-64 64-64z"/></svg>
                        </button>
                        <button id="export-btn" title="Export Shortcuts" class="text-[var(--color-text-secondary)] hover:text-[var(--color-primary)] p-2 rounded-full text-sm cursor-pointer">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="w-5 h-5" fill="currentColor">
                                <path d="M288 32c0-17.7-14.3-32-32-32s-32 14.3-32 32V274.7l-73.4-73.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5-32.8 0-45.3l128 128c12.5 12.5 32.8 12.5 45.3 0l128-128c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L288 274.7V32zM64 416c0-17.7-14.3-32-32-32s-32 14.3-32 32v32c0 35.3 28.7 64 64 64H448c35.3 0 64-28.7 64-64V416c0-17.7-14.3-32-32-32s-32 14.3-32 32v16H96V416z"/>
                            </svg>
                        </button>
                    </div>
                </div>
                <input type="file" id="import-file" class="hidden" accept=".json">
                <div id="shortcuts-list" class="grid grid-cols-2 md:grid-cols-3 gap-2 mt-2">
                </div>
            </div>
        </aside>

        <div id="resizer" class="hidden md:block w-1.5 cursor-col-resize bg-[var(--color-resizer-bg)] hover:bg-[var(--color-primary)] transition-colors duration-200 z-10"></div>

        <main class="w-full p-6 flex flex-col flex-grow bg-[var(--color-background-main)] relative">
            <div id="tabs-wrapper" class="flex-shrink-0 -mx-6 -mt-6 mb-4 border-b border-[var(--color-border)]">
                <div id="tabs-container" class="flex items-end px-2 pt-2 overflow-x-auto">
                    </div>
            </div>

            <textarea id="minutes-editor" class="w-full h-full p-4 text-base bg-transparent border-none rounded-lg resize-none focus:outline-none placeholder:text-[var(--color-placeholder)]" placeholder="Start writing your minutes here... Your work is saved automatically. Use your shortcuts or click on them to insert text."></textarea>
            
            <div id="editor-controls" class="absolute bottom-5 right-5 flex space-x-2">
                <button id="zoom-in-btn" title="Zoom In" class="w-10 h-10 flex items-center justify-center bg-gray-700 hover:bg-gray-600 text-white rounded-full shadow-lg cursor-pointer transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7" /></svg>
                </button>
                <button id="zoom-out-btn" title="Zoom Out" class="w-10 h-10 flex items-center justify-center bg-gray-700 hover:bg-gray-600 text-white rounded-full shadow-lg cursor-pointer transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM13 10H7" /></svg>
                </button>
            </div>
        </main>
    </div>

    <div id="toast" class="fixed bottom-5 right-5 bg-gray-800 text-white py-2 px-4 rounded-lg shadow-lg opacity-0 translate-y-10 transition-all duration-300">
        <p id="toast-message"></p>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- Element References ---
        const themeToggle = document.getElementById('theme-toggle');
        const shortcutForm = document.getElementById('shortcut-form');
        const shortcutKeyInput = document.getElementById('shortcut-key');
        const shortcutTextInput = document.getElementById('shortcut-text');
        const shortcutsList = document.getElementById('shortcuts-list');
        const minutesEditor = document.getElementById('minutes-editor');
        const toast = document.getElementById('toast');
        const toastMessage = document.getElementById('toast-message');
        const importBtn = document.getElementById('import-btn');
        const exportBtn = document.getElementById('export-btn');
        const importFileInput = document.getElementById('import-file');
        const resizer = document.getElementById('resizer');
        const leftPanel = document.getElementById('left-panel');
        const toggleFormBtn = document.getElementById('toggle-form-btn');
        const addShortcutContainer = document.getElementById('add-shortcut-container');
        const formTitle = document.getElementById('form-title');
        const formSubmitBtn = document.getElementById('form-submit-btn');
        const submitBtnText = document.getElementById('submit-btn-text');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        const manageShortcutsBtn = document.getElementById('manage-shortcuts-btn');
        const zoomInBtn = document.getElementById('zoom-in-btn');
        const zoomOutBtn = document.getElementById('zoom-out-btn');
        const tabsContainer = document.getElementById('tabs-container');

        // --- SVG Icon Definitions ---
        const icons = {
            chevronUp: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="w-5 h-5" fill="currentColor"><path d="M233.4 105.4c12.5-12.5 32.8-12.5 45.3 0l192 192c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L256 173.3 86.6 342.6c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3l192-192z"/></svg>`,
            chevronDown: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="w-5 h-5" fill="currentColor"><path d="M233.4 406.6c12.5 12.5 32.8 12.5 45.3 0l192-192c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L256 338.7 86.6 169.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l192 192z"/></svg>`,
            pencilSmall: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="w-full h-full" fill="currentColor"><path d="M410.3 231l11.3-11.3-33.9-33.9-62.1-62.1L291.7 89.8l-11.3 11.3-22.6 22.6L58.6 322.9c-10.4 10.4-18 23.3-22.2 37.4L1 480.7c-2.5 8.4-.2 17.5 6.1 23.7s15.3 8.5 23.7 6.1l120.3-35.4c14.1-4.2 27-11.8 37.4-22.2L387.7 253.7 410.3 231zM160 399.4l-9.1 22.7c-4 3.1-8.5 5.4-13.3 6.9L5.9 452.5l22.7-9.1c3.1-4 5.4-8.5 6.9-13.3l22.7-9.1z"/></svg>`,
            timesSmall: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512" class="w-full h-full" fill="currentColor"><path d="M342.6 150.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L192 210.7 86.6 105.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3L146.7 256 41.4 361.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0L192 301.3 297.4 406.6c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L237.3 256 342.6 150.6z"/></svg>`,
            plus: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="w-4 h-4" fill="currentColor"><path d="M256 80c0-17.7-14.3-32-32-32s-32 14.3-32 32V224H48c-17.7 0-32 14.3-32 32s14.3 32 32 32H192V432c0 17.7 14.3 32 32 32s32-14.3 32-32V288H400c17.7 0 32-14.3 32-32s-14.3-32-32-32H256V80z"/></svg>`,
            close: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512" class="w-3 h-3" fill="currentColor"><path d="M342.6 150.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L192 210.7 86.6 105.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3L146.7 256 41.4 361.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0L192 301.3 297.4 406.6c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L237.3 256 342.6 150.6z"/></svg>`
        };

        // --- State Variables ---
        let shortcuts = [];
        let keyCombination = { key: '', ctrl: false, alt: false, shift: false };
        let editingIndex = null;
        let isEditMode = false;
        let editorFontSize = 16;
        let sortable = null;
        let workspaces = [];
        let activeWorkspaceId = null;

        const debounce = (func, delay) => {
            let timeout;
            return (...args) => {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), delay);
            };
        };

        const showToast = (message, isError = false) => {
            toastMessage.textContent = message;
            toast.classList.remove('opacity-0', 'translate-y-10', 'bg-red-600', 'bg-gray-800');
            toast.classList.add(isError ? 'bg-red-600' : 'bg-gray-800');
            setTimeout(() => {
                toast.classList.add('opacity-0', 'translate-y-10');
            }, 3000);
        };
        
        // --- Workspace and Tab Management ---
        const renderTabs = () => {
            tabsContainer.innerHTML = '';
            workspaces.forEach(workspace => {
                const isActive = workspace.id === activeWorkspaceId;
                const tabEl = document.createElement('div');
                tabEl.dataset.id = workspace.id;
                tabEl.className = `tab-item flex-shrink-0 flex items-center justify-between pl-4 pr-2 py-2 text-sm border-r border-t rounded-t-lg cursor-pointer max-w-[150px] ${
                    isActive 
                    ? 'bg-[var(--color-background-main)] text-[var(--color-text-primary)] border-[var(--color-border)]' 
                    : 'bg-[var(--color-background)] text-[var(--color-text-secondary)] border-transparent hover:bg-[var(--color-secondary-bg)]'
                }`;
                
                const nameSpan = document.createElement('span');
                nameSpan.className = 'tab-name truncate';
                nameSpan.title = workspace.name;
                nameSpan.textContent = workspace.name;
                
                const closeBtn = document.createElement('button');
                closeBtn.title = 'Close Workspace';
                closeBtn.className = 'close-tab-btn ml-2 p-1.5 rounded-full hover:bg-[var(--color-icon-hover-bg)]';
                closeBtn.innerHTML = icons.close;

                tabEl.appendChild(nameSpan);
                tabEl.appendChild(closeBtn);
                tabsContainer.appendChild(tabEl);
            });

            const addTabBtn = document.createElement('button');
            addTabBtn.id = 'add-tab-btn';
            addTabBtn.title = 'New Workspace';
            addTabBtn.className = 'ml-2 p-2 rounded-full text-[var(--color-text-secondary)] hover:bg-[var(--color-icon-hover-bg)] flex-shrink-0';
            addTabBtn.innerHTML = icons.plus;
            tabsContainer.appendChild(addTabBtn);
        };

        const loadActiveWorkspaceContent = () => {
            const activeWorkspace = workspaces.find(w => w.id === activeWorkspaceId);
            minutesEditor.value = activeWorkspace ? activeWorkspace.content : '';
            minutesEditor.focus();
        };

        const saveWorkspaces = () => {
            const activeWorkspace = workspaces.find(w => w.id === activeWorkspaceId);
            if (activeWorkspace) {
                activeWorkspace.content = minutesEditor.value;
            }
            localStorage.setItem('minutesWriterWorkspaces', JSON.stringify(workspaces));
            localStorage.setItem('minutesWriterActiveWorkspaceId', activeWorkspaceId);
        };
        const debouncedSave = debounce(saveWorkspaces, 500);

        const loadWorkspaces = () => {
            const savedWorkspaces = localStorage.getItem('minutesWriterWorkspaces');
            const savedActiveId = localStorage.getItem('minutesWriterActiveWorkspaceId');

            if (savedWorkspaces) {
                workspaces = JSON.parse(savedWorkspaces);
                activeWorkspaceId = parseInt(savedActiveId, 10);
                if (!workspaces.some(w => w.id === activeWorkspaceId)) {
                    activeWorkspaceId = workspaces[0]?.id || null;
                }
            } else {
                const oldContent = localStorage.getItem('minutesWriterContent');
                const newId = Date.now();
                workspaces = [{ id: newId, name: 'Workspace 1', content: oldContent || '' }];
                activeWorkspaceId = newId;
                if(oldContent) localStorage.removeItem('minutesWriterContent');
            }

            if (workspaces.length === 0) {
                 const newId = Date.now();
                 workspaces = [{ id: newId, name: 'Workspace 1', content: '' }];
                 activeWorkspaceId = newId;
            }

            renderTabs();
            loadActiveWorkspaceContent();
        };

        const addWorkspace = () => {
            const newId = Date.now();
            const newWorkspace = { id: newId, name: `Workspace ${workspaces.length + 1}`, content: '' };
            workspaces.push(newWorkspace);
            activeWorkspaceId = newId;
            saveWorkspaces();
            renderTabs();
            loadActiveWorkspaceContent();
        };

        const switchWorkspace = (id) => {
            if (id === activeWorkspaceId) return;
            activeWorkspaceId = id;
            localStorage.setItem('minutesWriterActiveWorkspaceId', activeWorkspaceId);
            renderTabs();
            loadActiveWorkspaceContent();
        };

        const closeWorkspace = (idToClose) => {
            if (workspaces.length <= 1) {
                showToast("You cannot close the last workspace.", true);
                return;
            }
            const indexToClose = workspaces.findIndex(w => w.id === idToClose);
            workspaces.splice(indexToClose, 1);
            if (idToClose === activeWorkspaceId) {
                const newActiveIndex = Math.max(0, indexToClose - 1);
                activeWorkspaceId = workspaces[newActiveIndex].id;
            }
            saveWorkspaces();
            renderTabs();
            loadActiveWorkspaceContent();
        };
        
        const handleRename = (tabId, nameSpan) => {
            const originalName = nameSpan.textContent;
            const input = document.createElement('input');
            input.type = 'text';
            input.value = originalName;
            input.className = 'tab-rename-input';
            
            nameSpan.replaceWith(input);
            input.focus();
            input.select();
            
            const saveRename = () => {
                const newName = input.value.trim();
                const workspace = workspaces.find(w => w.id === tabId);
                if (workspace && newName) {
                    workspace.name = newName;
                }
                saveWorkspaces();
                renderTabs();
            };

            input.addEventListener('blur', saveRename);
            input.addEventListener('keydown', (e) => {
                if(e.key === 'Enter') {
                    input.blur();
                } else if (e.key === 'Escape') {
                    input.removeEventListener('blur', saveRename); // prevent saving on blur
                    renderTabs(); // just re-render to cancel
                }
            });
        };

        tabsContainer.addEventListener('click', (e) => {
            const tabItem = e.target.closest('.tab-item');
            const addBtn = e.target.closest('#add-tab-btn');
            if (addBtn) return addWorkspace();
            if (!tabItem) return;

            const id = parseInt(tabItem.dataset.id, 10);
            if (e.target.closest('.close-tab-btn')) {
                e.stopPropagation();
                closeWorkspace(id);
            } else {
                switchWorkspace(id);
            }
        });

        tabsContainer.addEventListener('dblclick', (e) => {
            const nameSpan = e.target.closest('.tab-name');
            if(nameSpan) {
                const tabItem = nameSpan.closest('.tab-item');
                const id = parseInt(tabItem.dataset.id, 10);
                handleRename(id, nameSpan);
            }
        });

        // --- All other functions (shortcuts, etc.) ---
        // [The rest of the JavaScript from the previous step goes here, unchanged]
        // ...
        const renderShortcuts = () => {
            shortcutsList.innerHTML = '';
            if (shortcuts.length === 0) {
                shortcutsList.innerHTML = `<p class="text-sm text-[var(--color-text-secondary)] text-center py-4 col-span-full">No shortcuts added yet.</p>`;
                return;
            }
            shortcuts.forEach((shortcut, index) => {
                const shortcutEl = document.createElement('div');
                let classList = 'relative flex flex-col items-center justify-center bg-[var(--color-background-main)] p-3 rounded-lg shadow-sm border border-[var(--color-border)] group';
                classList += isEditMode ? ' cursor-move' : ' cursor-pointer';
                shortcutEl.className = classList;

                shortcutEl.title = isEditMode ? 'Drag to reorder' : `Click to insert: "${shortcut.text}"`;
                shortcutEl.dataset.index = index;
                shortcutEl.dataset.id = shortcut.id;
                
                shortcutEl.innerHTML = `
                    <p class="w-full text-sm text-center text-[var(--color-text-primary)] font-medium truncate">${shortcut.text}</p>
                    <kbd class="mt-1.5 text-center px-2 py-1 text-xs font-semibold text-[var(--color-kbd-text)] bg-[var(--color-kbd-bg)] border border-[var(--color-kbd-border)] rounded-md">${shortcut.display}</kbd>
                    <div class="shortcut-actions absolute top-1.5 right-1.5 flex items-center space-x-1 opacity-0 transition-opacity duration-200">
                        <button title="Edit Shortcut" data-index="${index}" class="edit-shortcut bg-blue-100 hover:bg-blue-200 dark:bg-gray-600 dark:hover:bg-gray-500 text-blue-600 dark:text-blue-300 w-6 h-6 flex items-center justify-center rounded-full text-xs cursor-pointer transition-shadow hover:shadow-lg p-1">
                            <span class="w-4 h-4">${icons.pencilSmall}</span>
                        </button>
                        <button title="Delete Shortcut" data-index="${index}" class="delete-shortcut bg-red-100 hover:bg-red-200 dark:bg-gray-600 dark:hover:bg-gray-500 text-red-600 dark:text-red-300 w-6 h-6 flex items-center justify-center rounded-full text-xs cursor-pointer transition-shadow hover:shadow-lg p-1">
                            <span class="w-4 h-4">${icons.timesSmall}</span>
                        </button>
                    </div>
                `;
                shortcutsList.appendChild(shortcutEl);
            });
        };
        const saveShortcuts = () => localStorage.setItem('minutesWriterShortcuts', JSON.stringify(shortcuts));
        const loadShortcuts = () => {
            const saved = localStorage.getItem('minutesWriterShortcuts');
            if (saved) shortcuts = JSON.parse(saved);
            renderShortcuts();
        };
        const formatKeyForDisplay=c=>{let t=[];return c.ctrl&&t.push("Ctrl"),c.alt&&t.push("Alt"),c.shift&&t.push("Shift"),c.key&&t.push(c.key.charAt(0).toUpperCase()+c.key.slice(1)),t.join(" + ")},parseIdToKeyCombination=c=>{const t={key:"",ctrl:!1,alt:!1,shift:!1};return c.split("-").forEach(c=>{const[e,a]=c.split(":");"key"===e?t.key=a:t[e]="true"===a}),t},formatKeyForId=c=>`ctrl:${c.ctrl}-alt:${c.alt}-shift:${c.shift}-key:${c.key.toLowerCase()}`,enterEditMode=c=>{editingIndex=c;const t=shortcuts[c];keyCombination=parseIdToKeyCombination(t.id),shortcutKeyInput.value=t.display,shortcutTextInput.value=t.text,formTitle.textContent="Edit Shortcut",submitBtnText.textContent="Save Changes",document.getElementById("icon-plus").classList.add("hidden"),document.getElementById("icon-save").classList.remove("hidden"),cancelEditBtn.classList.remove("hidden"),(addShortcutContainer.style.maxHeight==="0px"||!addShortcutContainer.style.maxHeight)&&toggleFormBtn.click(),shortcutTextInput.focus()},exitEditMode=()=>{editingIndex=null,keyCombination={key:"",ctrl:!1,alt:!1,shift:!1},shortcutForm.reset(),shortcutKeyInput.value="",formTitle.textContent="Add Shortcut",submitBtnText.textContent="Add Shortcut",document.getElementById("icon-plus").classList.remove("hidden"),document.getElementById("icon-save").classList.add("hidden"),cancelEditBtn.classList.add("hidden")},handleExport=()=>{if(0===shortcuts.length&&0===workspaces.length)return void showToast("Nothing to export.",!0);const c={shortcuts:shortcuts,workspaces:workspaces,activeWorkspaceId:activeWorkspaceId},t=new Blob([JSON.stringify(c,null,2)],{type:"application/json"}),e=URL.createObjectURL(t),a=document.createElement("a");a.href=e,a.download="minutes-writer-backup.json",a.click(),URL.revokeObjectURL(e),showToast("Full backup exported!")},handleImport=c=>{const t=c.target.files[0];if(t){const c=new FileReader;c.onload=c=>{try{const t=JSON.parse(c.target.result);if(t.shortcuts&&t.workspaces){Array.isArray(t.shortcuts)&&(shortcuts=t.shortcuts,saveShortcuts(),renderShortcuts()),Array.isArray(t.workspaces)&&(workspaces=t.workspaces,activeWorkspaceId=t.activeWorkspaceId||workspaces[0]?.id,saveWorkspaces(),renderTabs(),loadActiveWorkspaceContent()),showToast("Full backup restored!")}else{if(!Array.isArray(t)||t.some(c=>void 0===c.id||void 0===c.display||void 0===c.text))throw new Error("Invalid format.");let c=0;const e=new Set(shortcuts.map(c=>c.id));t.forEach(t=>{e.has(t.id)||(shortcuts.push(t),e.add(t.id),c++)}),c>0?(saveShortcuts(),renderShortcuts(),showToast(`${c} new shortcut(s) imported.`)):showToast("No new shortcuts found to import.",!0)}}catch(c){showToast("Import failed. Invalid JSON file.",!0)}finally{importFileInput.value=""}},c.readAsText(t)}},updateTheme=c=>{document.documentElement.classList.toggle("dark",c),localStorage.setItem("theme",c?"dark":"light")},updateEditorZoom=c=>{editorFontSize=Math.max(8,Math.min(32,c)),minutesEditor.style.fontSize=`${editorFontSize}px`,localStorage.setItem("editorFontSize",editorFontSize)},initSortable=()=>{sortable&&(sortable.destroy()),sortable=new Sortable(shortcutsList,{animation:150,ghostClass:"bg-blue-100",disabled:!isEditMode,onEnd:c=>{const{oldIndex:t,newIndex:e}=c;if(t!==e){const[a]=shortcuts.splice(t,1);shortcuts.splice(e,0,a),saveShortcuts(),renderShortcuts()}}})};
        themeToggle.addEventListener('click', () => updateTheme(document.documentElement.classList.toggle('dark')));
        manageShortcutsBtn.addEventListener('click', () => { isEditMode = !isEditMode; shortcutsList.classList.toggle('edit-mode-active', isEditMode); document.getElementById('icon-pencil').classList.toggle('hidden', isEditMode); document.getElementById('icon-check').classList.toggle('hidden', !isEditMode); manageShortcutsBtn.title = isEditMode ? 'Done Editing' : 'Manage Shortcuts'; if (!isEditMode && editingIndex !== null) exitEditMode(); sortable.option('disabled', !isEditMode); renderShortcuts(); });
        shortcutKeyInput.addEventListener('keydown', e => { e.preventDefault(); if (['Control', 'Alt', 'Shift', 'Meta'].includes(e.key)) return; keyCombination = { key: e.key, ctrl: e.ctrlKey, alt: e.altKey, shift: e.shiftKey }; shortcutKeyInput.value = formatKeyForDisplay(keyCombination); });
        shortcutForm.addEventListener('submit', e => { e.preventDefault(); const text = shortcutTextInput.value.trim(); const display = shortcutKeyInput.value; if (!display || !text || !keyCombination.key) return showToast('Both key and text fields are required.', true); const id = formatKeyForId(keyCombination); if (shortcuts.some((s, i) => s.id === id && i !== editingIndex)) return showToast('This shortcut already exists.', true); if (editingIndex !== null) { shortcuts[editingIndex] = { id, display, text }; showToast('Shortcut updated!'); } else { shortcuts.push({ id, display, text }); showToast('Shortcut added!'); } saveShortcuts(); renderShortcuts(); exitEditMode(); });
        shortcutsList.addEventListener('click', e => { const target = e.target.closest('button, .group'); if (!target) return; if (target.matches('.delete-shortcut')) { e.stopPropagation(); const index = parseInt(target.dataset.index, 10); if (editingIndex === index) exitEditMode(); shortcuts.splice(index, 1); saveShortcuts(); renderShortcuts(); showToast('Shortcut deleted.'); return; } if (target.matches('.edit-shortcut')) { e.stopPropagation(); enterEditMode(parseInt(target.dataset.index, 10)); return; } if (target.matches('.group') && !isEditMode) { const shortcut = shortcuts[parseInt(target.dataset.index, 10)]; if (shortcut) { const { selectionStart, selectionEnd, value } = minutesEditor; minutesEditor.value = value.substring(0, selectionStart) + shortcut.text + value.substring(selectionEnd); minutesEditor.selectionStart = minutesEditor.selectionEnd = selectionStart + shortcut.text.length; minutesEditor.focus(); debouncedSave(); } } });
        minutesEditor.addEventListener('keydown', e => { const id = formatKeyForId({ key: e.key, ctrl: e.ctrlKey, alt: e.altKey, shift: e.shiftKey }); const shortcut = shortcuts.find(s => s.id === id); if (shortcut) { e.preventDefault(); const { selectionStart, selectionEnd, value } = minutesEditor; minutesEditor.value = value.substring(0, selectionStart) + shortcut.text + value.substring(selectionEnd); minutesEditor.selectionStart = minutesEditor.selectionEnd = selectionStart + shortcut.text.length; debouncedSave(); } });
        minutesEditor.addEventListener('keyup', debouncedSave);
        importBtn.addEventListener('click', () => importFileInput.click());
        exportBtn.addEventListener('click', handleExport);
        importFileInput.addEventListener('change', handleImport);
        cancelEditBtn.addEventListener('click', exitEditMode);
        zoomInBtn.addEventListener('click', () => updateEditorZoom(editorFontSize + 2));
        zoomOutBtn.addEventListener('click', () => updateEditorZoom(editorFontSize - 2));
        toggleFormBtn.addEventListener('click', () => { const container = document.getElementById('toggle-form-icon-container'); const isCollapsing = addShortcutContainer.style.maxHeight && addShortcutContainer.style.maxHeight !== '0px'; addShortcutContainer.style.maxHeight = isCollapsing ? '0px' : addShortcutContainer.scrollHeight + "px"; container.innerHTML = isCollapsing ? icons.chevronDown : icons.chevronUp; localStorage.setItem('formCollapsed', isCollapsing); });
        const initResizer=()=>{let t=0,e=0;const a=a=>{const o=e+a.clientX-t;o>250&&o<window.innerWidth-250&&(leftPanel.style.width=`${o}px`)},o=()=>{document.removeEventListener("mousemove",a),document.removeEventListener("mouseup",o),localStorage.setItem("panelWidth",leftPanel.style.width)};resizer.addEventListener("mousedown",c=>{c.preventDefault(),t=c.clientX,e=leftPanel.getBoundingClientRect().width,document.addEventListener("mousemove",a),document.addEventListener("mouseup",o)})};

        // --- INITIALIZATION ---
        const init = () => {
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const savedTheme = localStorage.getItem('theme');
            updateTheme(savedTheme === 'dark' || (!savedTheme && prefersDark));
            
            loadShortcuts();
            loadWorkspaces();
            initResizer();
            initSortable();

            const savedWidth = localStorage.getItem('panelWidth');
            if (savedWidth) leftPanel.style.width = savedWidth;
            
            const savedFontSize = localStorage.getItem('editorFontSize');
            if (savedFontSize) updateEditorZoom(parseInt(savedFontSize, 10));

            addShortcutContainer.style.transition = 'max-height 0.3s ease-in-out';
            const formCollapsed = localStorage.getItem('formCollapsed') === 'true';
            if (formCollapsed) {
                addShortcutContainer.style.maxHeight = '0px';
                document.getElementById('toggle-form-icon-container').innerHTML = icons.chevronDown;
            } else {
                setTimeout(() => {
                    addShortcutContainer.style.maxHeight = addShortcutContainer.scrollHeight + "px";
                    document.getElementById('toggle-form-icon-container').innerHTML = icons.chevronUp;
                }, 100);
            }
        };

        init();
    });
    </script>
</body>
</html>